/**
 * Vulnerability Scanner App
 * 
 * Scans code for common security anti-patterns and vulnerabilities.
 */

import { AppDefinition, AppContext, AppOutput, OutputSection } from '../types';

export const vulnerabilityScannerApp: AppDefinition = {
    id: 'vulnerability-scanner',
    name: 'Vulnerability Scanner',
    description: 'Scan code for security anti-patterns and vulnerabilities',
    icon: 'üõ°Ô∏è',
    category: 'security',
    helpDocumentation: `
### What is this?
The **Vulnerability Scanner** is a static analysis tool that scans your code for common security anti-patterns, potential exploits, and poor security hygiene. It maps findings to OWASP standards.

### How to use it:
1. **Provide Code**: Either paste a snippet directly or leave the field empty to scan the file currently open in your editor.
2. **Select Depth**: 
   - **Quick Scan**: Best for common accidental exposures (secrets, basic injection).
   - **Standard Scan**: Recommended for general code health.
   - **Deep Audit**: Use before major releases or on high-security modules.
3. **Review**: Findings are categorized by severity. Check the "Fix" section for recommended code changes.

### Use cases:
- Pre-commit security check.
- Auditing third-party code snippets.
- Validating sanitization logic.
    `,

    inputs: [
        {
            id: 'codeSnippet',
            label: 'Code to Scan',
            type: 'code',
            placeholder: 'Paste code here or leave empty to scan current file...',
            required: false,
            hint: 'If empty, the currently active file in your editor will be analyzed for vulnerabilities.'
        },
        {
            id: 'scanDepth',
            label: 'Scan Depth',
            type: 'select',
            defaultValue: 'standard',
            options: [
                { value: 'quick', label: '‚ö° Quick Scan', description: 'Checks for the Top 10 most common security anti-patterns' },
                { value: 'standard', label: 'üîç Standard Scan', description: 'Comprehensive analysis of common and complex vulnerabilities' },
                { value: 'deep', label: 'üî¨ Deep Audit', description: 'Exhaustive security analysis including subtle edge cases' }
            ],
            hint: 'Select how deep you want the security analysis to go.'
        }
    ],

    primaryAction: 'Start Security Scan',

    systemPrompt: `You are a world-class security researcher and professional white-hat pentester.
Your goal is to identify potential security vulnerabilities, anti-patterns, and compliance issues in the provided code.

## Scanning Guidelines
1. **Be Precise**: Minimize false positives. Explain why something is a risk.
2. **Follow OWASP**: Reference OWASP Top 10 categories where applicable.
3. **Check for**:
    - Injection (SQL, NoSQL, OS, LDAPs)
    - Broken Authentication & Session Management
    - Sensitive Data Exposure
    - XML External Entities (XXE)
    - Broken Access Control
    - Security Misconfiguration
    - Cross-Site Scripting (XSS)
    - Insecure Deserialization
    - Using Components with Known Vulnerabilities
    - Insufficient Logging & Monitoring

## Output Format
Structure your report using these sections:

### üö® Critical Vulnerabilities
Issues that pose an immediate risk of data breach or system compromise.
Format:
- **[Severity: CRITICAL]** Title
  - **Type**: OWASP Category
  - **Risk**: What could happen
  - **Fix**: Remediated code snippet

### ‚ö†Ô∏è Security Warnings
Potential issues or anti-patterns that increase the attack surface.
Same format as above.

### üìù Best Practices
General security improvements and hygiene.

### üìä Security Score
- Overall Rating: A-F
- Issues Found: Critical (X), Warning (X), Info (X)`,

    buildUserPrompt: (inputs: Record<string, string>, context?: AppContext): string => {
        const parts: string[] = [];
        const code = inputs.codeSnippet || (context?.fileContents?.[0]?.content) || '';

        if (!code) {
            parts.push('## Note\nNo code content provided. Please provide a code snippet to scan.');
        } else {
            parts.push(`## Code to Scan\n\`\`\`\n${code}\n\`\`\``);
        }

        parts.push(`## Scan Depth\n${inputs.scanDepth || 'standard'}`);

        return parts.join('\n\n');
    },

    parseResponse: (response: string): AppOutput => {
        const sections: OutputSection[] = [];

        const criticalMatch = response.match(/### üö® Critical Vulnerabilities[\s\S]*?(?=###|$)/i);
        if (criticalMatch && !criticalMatch[0].includes('None found') && criticalMatch[0].length > 50) {
            sections.push({
                title: 'üö® Critical Vulnerabilities',
                content: criticalMatch[0].replace(/### üö® Critical Vulnerabilities[^\n]*\n/, '').trim(),
                severity: 'critical',
                collapsible: true,
                collapsed: false
            });
        }

        const warningsMatch = response.match(/### ‚ö†Ô∏è Security Warnings[\s\S]*?(?=###|$)/i);
        if (warningsMatch && !warningsMatch[0].includes('None found') && warningsMatch[0].length > 50) {
            sections.push({
                title: '‚ö†Ô∏è Security Warnings',
                content: warningsMatch[0].replace(/### ‚ö†Ô∏è Security Warnings[^\n]*\n/, '').trim(),
                severity: 'warning',
                collapsible: true,
                collapsed: false
            });
        }

        if (sections.length === 0) {
            return {
                type: 'markdown',
                content: response
            };
        }

        return {
            type: 'structured',
            content: response,
            sections,
            summary: `Security scan complete. Found ${sections.filter(s => s.severity === 'critical').length} critical issues.`
        };
    }
};
